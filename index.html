<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dilmener Navigasyon | Mobil v16</title>
    <style>
        :root { --primary: #2ecc71; --accent: #e74c3c; --dark: #2c3e50; --bg: #f5f6fa; }
        body { 
        margin: 0; 
        padding: 0; 
        overflow: hidden; 
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; /* TÃ¼rkÃ§e karakter dostu fontlar */
        }
        
        #top-bar { padding: 10px 20px; background: var(--dark); color: white; display: flex; gap: 15px; z-index: 1000; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; }
        .mode-user { background: var(--primary); }
        .mode-admin { background: #f39c12; }
        .btn-undo { background: #9b59b6; }
        .btn-reset { background: #c0392b; }

        .side-panel { position: absolute; top: 80px; width: 340px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 900; max-height: 80vh; overflow-y: auto; }
        #search-panel { left: 20px; }
        #editor-panel { right: 20px; background: #2d3436; color: white; display: none; }
        
        textarea { width: 100%; height: 70px; font-size: 10px; background: #1e272e; color: #2ecc71; border: 1px solid #444; border-radius: 5px; margin-top: 5px; font-family: monospace; resize: vertical; }
        label { font-size: 12px; font-weight: bold; margin-top: 10px; display: block; }

        #viewport { 
            width: 100vw; 
            height: 100vh; 
            position: fixed; 
            top: 0; 
            left: 0; 
            background: #dcdde1; 
            touch-action: none; /* Mobilde sayfa kaymasÄ±nÄ± engeller, haritayÄ± serbest bÄ±rakÄ±r */
        }
        
        #map-wrapper { 
            transform-origin: 0 0; 
            width: 100%; 
            height: 100%; 
        }

        svg { 
            width: 100%; 
            height: 100%; 
            display: block; 
        }

        .node-circle { fill: var(--accent); stroke: white; stroke-width: 2; r: 12; cursor: pointer; }
        .node-label { font-size: 13px; font-weight: bold; fill: black; paint-order: stroke; stroke: white; stroke-width: 3px; pointer-events: none; }
        .edge-line { stroke: #3498db; stroke-width: 6; opacity: 0.3; pointer-events: none; }
        .selected-node { fill: #f1c40f !important; r: 18; stroke: black; filter: drop-shadow(0 0 10px gold); }
        
        #nav-path { fill: none; stroke: #2ecc71; stroke-width: 14; stroke-linecap: round; stroke-linejoin: round; stroke-dasharray: 20; animation: flow 2s linear infinite; filter: drop-shadow(0 0 8px rgba(46,204,113,0.5)); }
        @keyframes flow { to { stroke-dashoffset: -40; } }

        .result-item { padding: 12px; border-bottom: 1px solid #eee; cursor: default; transition: 0.2s; border-radius: 5px; background: #fff; }
        .result-item:hover { background: #f9f9f9; }
        .result-item b { display: block; color: #2c3e50; }
        .result-item small { color: #7f8c8d; line-height: 1.4; display: block; margin-bottom: 8px; }

        .btn-action { padding: 6px 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 11px; font-weight: bold; transition: 0.2s; }
        .btn-start { background: #3498db; }
        .btn-end { background: #2ecc71; }
        .btn-action:hover { opacity: 0.8; }

        .zoom-controls { position: fixed; bottom: 30px; left: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .z-btn { width: 55px; height: 55px; font-size: 28px; border-radius: 50%; border: none; background: var(--dark); color: white; cursor: pointer; }
        #info-box { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.85); color: #2ecc71; padding: 15px; border-radius: 10px; font-family: monospace; font-size: 12px; pointer-events: none; z-index: 2000; min-width: 200px; line-height: 1.5; }

        /* Normalde tÃ¼m baÄŸlantÄ± Ã§izgilerini gizle */
        .edge-line { 
            stroke: #3498db; 
            stroke-width: 6; 
            opacity: 0.3; 
            display: none; /* VarsayÄ±lan olarak kapalÄ± */
            pointer-events: none; 
        }

        /* Sadece ADMIN modu aktifken bu Ã§izgileri gÃ¶ster */
        body.admin-mode .edge-line, 
        body.admin-mode .node-circle, 
        body.admin-mode .node-label { 
            display: block !important; 
        }

        /* Mobil DuyarlÄ±lÄ±k AyarlarÄ± */
        @media (max-width: 768px) {
            .side-panel {
                width: 95% !important;
                left: 2.5% !important;
                right: 2.5% !important;
                top: 65px;
                max-height: 45vh;
                padding: 15px;
            }
        #editor-panel { display: none !important; } /* Mobilde sadece kullanÄ±cÄ± modu */
        .z-btn { width: 50px; height: 50px; font-size: 24px; }
        .btn-action { padding: 12px 10px; font-size: 13px; } /* ButonlarÄ± bÃ¼yÃ¼ttÃ¼k */
        }

        /* Dokunmatik yÃ¼zeyde seÃ§ilmeyi engelle */
        #viewport { touch-action: none; user-select: none; -webkit-user-drag: none; }
    </style>
</head>
<body onkeydown="handleGlobalKeys(event)">

<div id="top-bar">
    <button class="btn mode-user" onclick="setMode('user')">ğŸ“ Yol Bul</button>
    <button class="btn mode-admin" onclick="setMode('admin')">ğŸ›  DÃ¼zenleme Modu</button>
    <button class="btn btn-undo" onclick="undo()">â†© Geri Al</button>
    <div style="flex:1"></div>
    <button class="btn btn-reset" onclick="resetApp()">ğŸ—‘ SÄ±fÄ±rla</button>
</div>

<div id="search-panel" class="side-panel">
    <input type="text" id="searchInput" placeholder="BÃ¶lÃ¼m, Doktor, Etiket veya Birim ara..." onkeyup="aramaYap()" style="width:100%; padding:12px; border-radius:8px; border:2px solid #ddd; box-sizing: border-box;">
    <div id="results" style="margin-top:10px;"></div>
</div>

<div id="editor-panel" class="side-panel">
    <h3 style="margin:0">Veri YÃ¶netimi</h3>
    
    <label>1. SVG Kodu:</label>
    <textarea id="svgInput" oninput="manualSVGUpdate()"></textarea>
    
    <label>2. Nodes (Noktalar) JSON:</label>
    <textarea id="nodesInput" oninput="manualDataUpdate()"></textarea>
    
    <label>3. Edges (Yollar) JSON:</label>
    <textarea id="edgesInput" oninput="importEdges()"></textarea>

    <label>4. HiyerarÅŸi (Arama) JSON:</label>
    <textarea id="hieInput" oninput="manualHieUpdate()" placeholder='[{"sorumlu":"...","ad":"...","id":"...","alt_blok":"...","blok":"...","etiketler":"..."}]'></textarea>

    <div style="font-size:11px; margin-top:10px; color:#bdc3c7;">
        <b>Ä°pucu:</b> VeritabanÄ± formatÄ±: sorumlu, ad, id, alt_blok, blok, etiketler.
    </div>
</div>

<div id="info-box">
    <b>ğŸ“ BaÅŸlangÄ±Ã§:</b> Giris<br>
    <b>ğŸ Hedef:</b> SeÃ§ilmedi
</div>

<div class="zoom-controls">
    <button class="z-btn" onclick="zoom(1.2)">+</button>
    <button class="z-btn" onclick="zoom(0.8)">-</button>
</div>

<div id="viewport" onmousedown="startPan(event)" onmousemove="doPan(event)" onmouseup="endPan()">
    <div id="map-wrapper" onclick="handleMapClick(event)"></div>
</div>

<div id="viewport" 
     onmousedown="startPan(event)" onmousemove="doPan(event)" onmouseup="endPan()"
     ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="endPan()">
    <div id="map-wrapper" onclick="handleMapClick(event)"></div>
</div>

<script>
let nodes = JSON.parse(localStorage.getItem('dilmener_nodes')) || [];
let edges = JSON.parse(localStorage.getItem('dilmener_edges')) || [];
let hierarchy = JSON.parse(localStorage.getItem('dilmener_hie')) || [];
let savedSVG = localStorage.getItem('dilmener_svg') || "";
let history = [];

let mode = 'user';
let scale = 0.5, pointX = 0, pointY = 0;
let isPanning = false, startX, startY;
let selectedId = null;
let lastClickedId = null;

// Navigasyon DeÄŸiÅŸkenleri
let currentStartId = "Giris";
let currentEndId = null;
let currentStartName = "Giris";
let currentEndName = "SeÃ§ilmedi";

window.onload = () => {
    if (savedSVG) document.getElementById('map-wrapper').innerHTML = savedSVG;
    document.getElementById('hieInput').value = JSON.stringify(hierarchy, null, 2);
    syncUI();
    render();
};

function saveState() {
    if (history.length > 20) history.shift();
    history.push({ nodes: JSON.parse(JSON.stringify(nodes)), edges: JSON.parse(JSON.stringify(edges)) });
    localStorage.setItem('dilmener_nodes', JSON.stringify(nodes));
    localStorage.setItem('dilmener_edges', JSON.stringify(edges));
    syncUI();
    render();
}

function undo() {
    if (history.length > 0) {
        let lastState = history.pop();
        nodes = lastState.nodes;
        edges = lastState.edges;
        localStorage.setItem('dilmener_nodes', JSON.stringify(nodes));
        localStorage.setItem('dilmener_edges', JSON.stringify(edges));
        syncUI();
        render();
    }
}

function syncUI() {
    document.getElementById('nodesInput').value = JSON.stringify(nodes, null, 2);
    document.getElementById('edgesInput').value = JSON.stringify(edges, null, 2);
    document.getElementById('svgInput').value = localStorage.getItem('dilmener_svg') || "";
    updateInfoBox();
}

function updateInfoBox() {
    const node = nodes.find(n => n.id === selectedId);
    let infoHTML = `<b>ğŸ“ BaÅŸlangÄ±Ã§:</b> ${currentStartName}<br><b>ğŸ Hedef:</b> ${currentEndName}`;
    if(node && mode === 'admin') {
        infoHTML += `<hr><b>SeÃ§ili Nokta:</b><br>ID: ${node.id}<br>X: ${node.x} | Y: ${node.y}`;
    }
    document.getElementById('info-box').innerHTML = infoHTML;
}

function handleGlobalKeys(e) {
    if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
    if (e.key === "+" || e.key === "=") { zoom(1.1); e.preventDefault(); return; }
    if (e.key === "-") { zoom(0.9); e.preventDefault(); return; }
    if (e.key === "Escape") { selectedId = null; lastClickedId = null; render(); syncUI(); return; }
    if ((e.key === "Delete" || e.key === "Backspace") && selectedId && mode === 'admin') {
        saveState();
        edges = edges.filter(ed => ed.from !== selectedId && ed.to !== selectedId);
        nodes = nodes.filter(n => n.id !== selectedId);
        selectedId = null;
        saveState();
        return;
    }
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
        e.preventDefault();
        const step = e.shiftKey ? 10 : 1;
        const panStep = e.shiftKey ? 50 : 10;
        if (selectedId && mode === 'admin') {
            nodes = nodes.map(n => {
                if (n.id === selectedId) {
                    if (e.key === 'ArrowUp') n.y -= step;
                    if (e.key === 'ArrowDown') n.y += step;
                    if (e.key === 'ArrowLeft') n.x -= step;
                    if (e.key === 'ArrowRight') n.x += step;
                }
                return n;
            });
            saveState();
        } else {
            if (e.key === 'ArrowUp') pointY += panStep;
            if (e.key === 'ArrowDown') pointY -= panStep;
            if (e.key === 'ArrowLeft') pointX += panStep;
            if (e.key === 'ArrowRight') pointX -= panStep;
            updateTrans();
        }
    }
}

function handleMapClick(e) {
    if (mode !== 'admin' || e.target.tagName === 'circle') return;
    const svg = document.querySelector('svg');
    if (!svg) return;
    if (selectedId) { selectedId = null; lastClickedId = null; render(); syncUI(); return; }
    const pt = svg.createSVGPoint();
    pt.x = e.clientX; pt.y = e.clientY;
    const svgP = pt.matrixTransform(document.getElementById("map-wrapper").getScreenCTM().inverse());
    const newId = "n" + Date.now();
    saveState();
    nodes.push({ id: newId, x: Math.round(svgP.x), y: Math.round(svgP.y) });
    selectedId = newId;
    saveState();
}


function onNodeClick(id, e) {
    e.stopPropagation();
    if (mode !== 'admin') return;

    if (!lastClickedId) {
        // Ä°lk noktayÄ± seÃ§
        lastClickedId = id;
        selectedId = id;
    } else {
        if (lastClickedId !== id) {
            // BAÄLANTI SÄ°LME VEYA EKLEME MANTIÄI (Toggle)
            // Daha Ã¶nce bu iki nokta arasÄ±nda bir baÄŸlantÄ± olup olmadÄ±ÄŸÄ±nÄ± kontrol et
            const idx = edges.findIndex(ed => 
                (ed.from === lastClickedId && ed.to === id) || 
                (ed.from === id && ed.to === lastClickedId)
            );

            saveState(); // Geri alabilmek iÃ§in durumu kaydet

            if (idx > -1) {
                // EÄER VARSA: BaÄŸlantÄ±yÄ± sil
                edges.splice(idx, 1);
                console.log("BaÄŸlantÄ± silindi: " + lastClickedId + " <-> " + id);
            } else {
                // EÄER YOKSA: Yeni baÄŸlantÄ± ekle
                edges.push({ from: lastClickedId, to: id });
                console.log("Yeni baÄŸlantÄ± eklendi: " + lastClickedId + " <-> " + id);
            }
        }
        // SeÃ§imi temizle
        lastClickedId = null;
        selectedId = id;
    }
    saveState();
}

function onNodeDblClick(id, e) {
    e.stopPropagation();
    if (mode !== 'admin') return;
    const newId = prompt("Nokta ismini deÄŸiÅŸtir:", id);
    if (newId && newId !== id) {
        saveState();
        edges = edges.map(ed => ({ from: ed.from === id ? newId : ed.from, to: ed.to === id ? newId : ed.to }));
        nodes = nodes.map(n => n.id === id ? { ...n, id: newId } : n);
        selectedId = newId;
        saveState();
    }
}

function manualSVGUpdate() {
    const val = document.getElementById('svgInput').value;
    if (val.includes('<svg')) {
        document.getElementById('map-wrapper').innerHTML = val;
        localStorage.setItem('dilmener_svg', val);
    }
}

function manualDataUpdate() { try { nodes = JSON.parse(document.getElementById('nodesInput').value); saveState(); } catch(e) {} }
function importEdges() { try { edges = JSON.parse(document.getElementById('edgesInput').value); saveState(); } catch(e) {} }

function manualHieUpdate() { 
    try { 
        const rawData = document.getElementById('hieInput').value;
        hierarchy = JSON.parse(rawData); 
        localStorage.setItem('dilmener_hie', JSON.stringify(hierarchy)); 
    } catch(e) { console.error("HiyerarÅŸi JSON hatasÄ±!"); } 
}

// --- AKILLI ARAMA MOTORU (Ã‡Ä°FT SEÃ‡Ä°MLÄ°) ---
function aramaYap() {
    const val = document.getElementById('searchInput').value.toLocaleLowerCase('tr').trim();
    const res = document.getElementById('results');
    res.innerHTML = "";
    
    if (val.length < 2) return;

    const filtered = hierarchy.filter(item => {
        const aramaMetni = [
            item.ad, item.sorumlu, item.blok, item.alt_blok, item.etiketler
        ].join(" ").toLocaleLowerCase('tr');
        return aramaMetni.includes(val);
    });

    filtered.forEach(item => {
        const div = document.createElement('div');
        div.className = "result-item";
        
        const gecerliMi = (deger) => {
            if (!deger) return false;
            const d = deger.toString().toLocaleLowerCase('tr').trim();
            return d !== "" && d !== "yok";
        };

        let detaylar = [];
        if (gecerliMi(item.sorumlu)) detaylar.push(`Sorumlu: ${item.sorumlu}`);
        if (gecerliMi(item.blok)) detaylar.push(item.blok);
        if (gecerliMi(item.alt_blok)) detaylar.push(item.alt_blok);

        div.innerHTML = `
            <b>${item.ad || "Ä°simsiz BÃ¶lÃ¼m"}</b>
            <small>${detaylar.length > 0 ? detaylar.join(" | ") : ""}</small>
            <div style="display:flex; gap:8px;">
                <button class="btn-action btn-start" onclick="selectStart('${item.id}', '${item.ad}')">ğŸ“ BuradayÄ±m</button>
                <button class="btn-action btn-end" onclick="selectEnd('${item.id}', '${item.ad}')">ğŸ Oraya Git</button>
            </div>
        `;
        res.appendChild(div);
    });
}

function selectStart(id, name) {
    currentStartId = id;
    currentStartName = name;
    updateInfoBox();
    if(currentEndId) rotaCiz(currentStartId, currentEndId);
}

function selectEnd(id, name) {
    currentEndId = id;
    currentEndName = name;
    updateInfoBox();
    document.getElementById('results').innerHTML = "";
    document.getElementById('searchInput').value = name;
    rotaCiz(currentStartId, currentEndId);
}

function render() {
    const svg = document.querySelector('svg');
    if (!svg) return;
    let layer = svg.getElementById('dynamic-layer');
    if (!layer) { layer = document.createElementNS("http://www.w3.org/2000/svg", "g"); layer.id = 'dynamic-layer'; svg.appendChild(layer); }
    layer.innerHTML = '';

    edges.forEach(e => {
        const n1 = nodes.find(n => n.id === e.from);
        const n2 = nodes.find(n => n.id === e.to);
        if (n1 && n2) {
            const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
            l.setAttribute("x1", n1.x); l.setAttribute("y1", n1.y);
            l.setAttribute("x2", n2.x); l.setAttribute("y2", n2.y);
            l.setAttribute("class", "edge-line");
            layer.appendChild(l);
        }
    });

    nodes.forEach(n => {
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        c.setAttribute("cx", n.x); c.setAttribute("cy", n.y);
        c.setAttribute("class", "node-circle " + (selectedId === n.id ? "selected-node" : ""));
        c.style.display = mode === 'admin' ? 'block' : 'none';
        c.onclick = (e) => onNodeClick(n.id, e);
        c.ondblclick = (e) => onNodeDblClick(n.id, e);
        const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
        t.setAttribute("x", n.x + 15); t.setAttribute("y", n.y + 5);
        t.setAttribute("class", "node-label");
        t.textContent = n.id;
        t.style.display = mode === 'admin' ? 'block' : 'none';
        g.appendChild(c); g.appendChild(t); layer.appendChild(g);
    });
}

function findShortestPath(startId, endId) {
    let dist = {}; let prev = {}; let q = new Set();
    nodes.forEach(n => { dist[n.id] = Infinity; prev[n.id] = null; q.add(n.id); });
    dist[startId] = 0;
    while (q.size > 0) {
        let u = Array.from(q).reduce((min, n) => dist[n] < dist[min] ? n : min);
        if (u === endId || dist[u] === Infinity) break;
        q.delete(u);
        edges.filter(e => e.from === u || e.to === u).forEach(e => {
            let v = e.from === u ? e.to : e.from;
            if (q.has(v)) {
                let alt = dist[u] + 1;
                if (alt < dist[v]) { dist[v] = alt; prev[v] = u; }
            }
        });
    }
    let path = []; let curr = endId;
    while (curr) { path.unshift(curr); curr = prev[curr]; }
    return path[0] === startId ? path : null;
}

function rotaCiz(start, end) {
    const pathIds = findShortestPath(start, end);
    if (!pathIds) { alert("Yol bulunamadÄ±! BaÄŸlantÄ±larÄ± kontrol edin."); return; }
    
    const svg = document.querySelector('svg');
    let pLine = document.getElementById('nav-path');
    if (!pLine) {
        pLine = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
        pLine.id = "nav-path";
        svg.appendChild(pLine);
    }
    const pathCoords = pathIds.map(id => nodes.find(n => n.id === id));
    pLine.setAttribute("points", pathCoords.map(p => `${p.x},${p.y}`).join(" "));
    
    const target = pathCoords[pathCoords.length - 1];
    pointX = -(target.x * scale) + (window.innerWidth / 2);
    pointY = -(target.y * scale) + (window.innerHeight / 2);
    updateTrans();
}

function zoom(f) { scale *= f; updateTrans(); }

function setMode(m) { 
    mode = m; 
    selectedId = null; 
    lastClickedId = null; 
    
    // Body'e mod bilgisini sÄ±nÄ±f olarak ekliyoruz
    if (m === 'admin') {
        document.body.classList.add('admin-mode');
    } else {
        document.body.classList.remove('admin-mode');
    }

    document.getElementById('editor-panel').style.display = m === 'admin' ? 'block' : 'none'; 
    render(); 
}
function startPan(e) { if(e.target.tagName==='circle' || e.target.tagName==='TEXTAREA' || e.target.tagName==='INPUT') return; isPanning = true; startX = e.clientX - pointX; startY = e.clientY - pointY; }
function doPan(e) { if (!isPanning) return; pointX = e.clientX - startX; pointY = e.clientY - startY; updateTrans(); }
function endPan() { isPanning = false; }
function updateTrans() { document.getElementById("map-wrapper").style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }
function resetApp() { if(confirm("TÃ¼m hafÄ±za silinecek!")) { localStorage.clear(); location.reload(); } }

// --- MOBÄ°L DOKUNMATÄ°K KONTROLLER ---
// Mevcut startPan yerine bu fonksiyonu ekle (veya gÃ¼ncelle)
function handleTouchStart(e) {
    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
    isPanning = true;
    const touch = e.touches[0];
    startX = touch.clientX - pointX;
    startY = touch.clientY - pointY;
}

function handleTouchMove(e) {
    if (!isPanning || e.touches.length !== 1) return;
    // SayfanÄ±n kendi kaydÄ±rma Ã¶zelliÄŸini durdurur
    e.preventDefault(); 
    const touch = e.touches[0];
    pointX = touch.clientX - startX;
    pointY = touch.clientY - startY;
    updateTrans();
}
</script>
</body>
</html>
